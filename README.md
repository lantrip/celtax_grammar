## Cuneiform Tree-sitter Grammar (Single Source of Truth)

This repository is the canonical source for the Cuneiform language grammar and editor queries. Both Zed and VSCode must consume this repo to stay in sync.

### What's in here

- `grammar.js`: Tree-sitter grammar definition (authoritative). Regenerate artifacts after changes.
- `queries/`: Editor queries shared across IDEs
  - `highlights.scm`: Syntax highlighting captures
  - `indents.scm`: Indentation behavior
  - `outline.scm`: Symbols/outline
  - `brackets.scm`: Bracket/brace matching
- `src/parser.c`, `src/grammar.json`, `src/node-types.json`: Generated by `tree-sitter generate`.
- `tree-sitter-cuneiform.wasm`: Web build of the parser (for web/VSCode).

### Edit flow

1. Make changes only here (in `grammar.js` and `queries/*.scm`).
2. Regenerate parser artifacts:

```
npx tree-sitter generate
```

3. Build wasm (optional, for VSCode/web):

```
npx tree-sitter build-wasm
```

4. Commit your changes. The commit SHA is the version identifier used by editors.

### Consuming in editors

Zed

- The Zed extension pins this repo by commit:

```
[grammars.cuneiform]
repository = "https://github.com/lantrip/cuneiform_grammar.git"
rev = "<commit-sha>"
```

- Queries are loaded from this repo. Do not vendor duplicate queries in the Zed extension.
- After grammar updates, bump `rev` to the new commit.

VSCode (Tree-sitter-based semantic tokens)

- Bundle the matching `tree-sitter-cuneiform.wasm` and `queries/` from the same commit.
- Initialize `web-tree-sitter` in the extension and map captures to VSCode semantic tokens.
- Avoid maintaining a divergent TextMate grammar; if kept temporarily, keep it minimal.

### Capture to token mapping (suggested)

- `@keyword`, `@keyword.control` → `keyword`
- `@type`, `@type.builtin` → `type`
- `@variable.special` → `variable`
- `@property` → `property`
- `@string` → `string`
- `@comment`, `@comment.doc` → `comment`
- `@punctuation.*` → `operator` (or a custom `punctuation`)
- `@markup.heading.1/2/3` → `label` or `namespace`

### Debugging checklist

- Confirm the file parses: use Tree-sitter playground or `tree-sitter parse <file.cune>`.
- Verify captures: run highlights query against the parse tree (playground or custom script).
- Ensure Zed `rev` equals the commit you expect.
- Ensure VSCode ships wasm + queries from the same commit.

### Versioning guidelines

- Treat grammar changes as breaking for both editors until both are bumped.
- Use conventional commits; reference affected nodes/captures in the message.
- Consider tagging releases (e.g., `v0.1.0`) and pinning editors to tags.

### Contact

Premise team — contributions welcome via PRs against this repo.

